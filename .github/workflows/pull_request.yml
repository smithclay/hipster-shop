name: Lightstep Pre-Deploy Check
on:
  pull_request:
#on: 
#   pull_request_review:
#    types: [submitted]

jobs:    
  deploy_check_job:
    runs-on: ubuntu-latest
    name: Verify Pre-Deploy Status

    steps:  
      - name: Checkout
        uses: actions/checkout@v2

      - name: Lightstep Pre-Deploy Check
        id: lightstep-predeploy
        uses: lightstep/lightstep-action-predeploy@v0.1.4
        with:
          lightstep_api_key: ${{ secrets.LIGHTSTEP_API_TOKEN }}
          pagerduty_api_token: ${{ secrets.PAGERDUTY_API_TOKEN }}
          rollbar_api_token: ${{ secrets.ROLLBAR_API_TOKEN }}

      # TODO: Diff files + get services
      # https://github.com/trilom/file-changes-action
      - name: Cache Snapshots
        id: cache-snapshots
        uses: actions/cache@v2
        with:
          path: /tmp/lightstep
          key: ${{ steps.lightstep-predeploy.outputs.lightstep_project }}-snapshots

      - name: Compare Snapshots
        id: lightstep-snapshot
        uses: lightstep/lightstep-action-snapshot@v2
        if: ${{ steps.lightstep-predeploy.outputs.lightstep_predeploy_status != 'ok' }}
        env:
          LS_ACCESS_TOKEN: ${{ secrets.LS_ACCESS_TOKEN }}
        with:
          lightstep_api_key: ${{ secrets.LIGHTSTEP_API_TOKEN }}
          lightstep_organization: ${{ steps.lightstep-predeploy.outputs.lightstep_organization }}
          lightstep_project: ${{ steps.lightstep-predeploy.outputs.lightstep_project }}
          lightstep_snapshot_before: 'MlbrYE7aU9'
          lightstep_snapshot_after: '4YJ5pIagGU'

      - name: Add Comment
        uses: unsplash/comment-on-pr@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          msg: ${{ steps.lightstep-predeploy.outputs.lightstep_predeploy_md }}
          check_for_duplicate_msg: true

      - name: Add Snapshot Diff Comment
        uses: unsplash/comment-on-pr@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          msg: ${{ steps.lightstep-snapshot.outputs.lightstep_snapshot_diff_md }}
          check_for_duplicate_msg: true